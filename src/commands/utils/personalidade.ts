import { WASocket, proto } from '@whiskeysockets/baileys';
import { ICommand } from '@/interfaces/ICommand';
import { Group } from '@/database/models/GroupSchema';
import { MessageContext } from '@/handlers/message.handler';

const personalidadeCommand: ICommand = {
  name: 'personalidade',
  description: 'üé≠ Mostra a personalidade ativa da Amanda no grupo',
  aliases: ['mood', 'persona'],
  category: 'utils',
  usage: '!personalidade',
  cooldown: 10,
  handle: async (context: MessageContext): Promise<void> => {
    const { sock, messageInfo: message } = context;
    const groupJid = message.key.remoteJid;
    
    try {
      if (!groupJid?.endsWith('@g.us')) {
        await sock.sendMessage(message.key.remoteJid!, {
          text: '‚ùå Este comando s√≥ funciona em grupos!'
        });
        return;
      }

      // FIX: Usar Group.findOne com fallback para personalidade padr√£o
      const group = await Group.findOne({ groupJid });
      const activePersonality = group?.activePersonality || 'padrao';
      
      // Mapa de personalidades para nomes amig√°veis
      const personalidades = {
        'padrao': 'A Padr√£o (Carioca Sexy)',
        'amante': 'A Especialista em Segredos',
        'casada': 'A Casada Safada',
        'desviada': 'A Crente Safada & Blasfema',
        'macumbeira': 'M√£e Amanda de Ox√≥ssi',
        'cartomante': 'Madame Amanda',
        'astrologa': 'Shakira da Tijuca',
        'coach_quantica': 'Gabi da Abund√¢ncia',
        'anitta': 'Empreendedora do Funk',
        'patroa': 'A Coach de Empoderamento',
        'policial': 'Cabo Amanda Nunes',
        'faria_limer': 'Jorginho do Bitcoin',
        'dr_fritz': 'Dr. Amanda Fritz',
        'crente': 'Irm√£ Amanda',
        'nerd': 'Doutora Amanda',
        'tia': 'Tia Amanda',
        'morty': 'O Ajudante Ansioso',
        'fofoqueira': 'A Intrigante',
        'cupido': 'A Ju√≠za do Amor',
        'dona_do_jogo': 'A Dona do Cassino'
      };

      const nomePersonalidade = personalidades[activePersonality as keyof typeof personalidades] || 'Desconhecida';
      
      // Informa√ß√µes adicionais
      let infoAdicional = '';
      
      if (group?.lastPersonalityChange) {
        const data = new Date(group.lastPersonalityChange);
        const dataFormatada = data.toLocaleDateString('pt-BR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        infoAdicional += `\nüïê *Alterada em:* ${dataFormatada}`;
      }
      
      if (group?.changedBy) {
        const adminNumber = group.changedBy.split('@')[0];
        infoAdicional += `\nüë§ *Por:* ${adminNumber}`;
      }
      
      const mensagem = `üé≠ *PERSONALIDADE ATIVA*\n\n` +
        `*${nomePersonalidade}*\n` +
        `üîë C√≥digo: \`${activePersonality}\`` +
        infoAdicional +
        `\n\nüí° Use *!person* para alterar a personalidade!`;
      
      await sock.sendMessage(groupJid, { text: mensagem });
      
    } catch (error) {
      console.error('Erro ao executar comando personalidade:', error);
      await sock.sendMessage(message.key.remoteJid!, {
        text: '‚ùå Ops! Deu ruim na hora de verificar a personalidade. Tenta de novo mais tarde!'
      });
    }
  }
};

export default personalidadeCommand; 